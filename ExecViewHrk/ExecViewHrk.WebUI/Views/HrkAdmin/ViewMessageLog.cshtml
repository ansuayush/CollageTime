
@model ExecViewHrk.WebUI.Models.EmailMessageLogModel
@{
    ViewBag.Title = "ViewMessageLog";
    Layout = "~/Views/Shared/_HrkAdminLayout.cshtml";
    AjaxOptions ajaxOptions = new AjaxOptions
    {
        //UpdateTargetId = "EmailContent",
        OnComplete = "OnComplete",
        OnSuccess = "OnSuccess",
        OnFailure = "OnFailure",
        HttpMethod = "POST",
        //InsertionMode =  InsertionMode.Replace
    };
}
<script>
    function OnSuccess(data) {
        
        var kendoWindow = $("#EmailWindow").data("kendoWindow");
        
        kendoWindow.close();

        alert(data);
    }

    function OnComplete() {
        //alert("Ajax complete");
    }

    function OnFailure() {
        alert("Ajax failure");
    }
</script>

<h2>View Message Log</h2>

<div>
    

    @(Html.Kendo().Grid<ExecViewHrk.EfAdmin.MessageLog>()
        .Name("grid")
        .Resizable(resize => resize.Columns(true))
        .Columns(columns =>
        {
            columns.Bound(c => c.MessageLogId).Width(100);
            columns.Bound(c => c.DateTime).Width(100).Format("{0:MM/dd/yyyy h:mm tt}"); 
            columns.Bound(c => c.Source).Width(200);
            columns.Bound(c => c.Message).Width(200);
            columns.Command(command =>
            {
                command.Custom("Email").Click("OnEmailClick")
                    .HtmlAttributes(new { id = "EmailLogId" });
            }).Width(120);
            
        })
        .HtmlAttributes(new { style = "height: 380px;" })
        
        .Scrollable()
        .Groupable()
        .Sortable()
        .Selectable()
        .Pageable(pageable => pageable
            .Refresh(false)
            .PageSizes(true)
            .ButtonCount(5))
        .DataSource(dataSource => dataSource
            .Ajax()
            .Read(read => read.Action("MessageLog_Read", "HrkAdmin"))
        )
    )

</div>

<div id="EmailWindow" style="display:none">
    <div id="EmailContent">

        @*@using (Html.BeginForm())*@
        @using (Ajax.BeginForm("SendEmailFromMessageLog", ajaxOptions))
        {

            <div class="form-group">
                <label>To</label>
                @Html.TextBoxFor(x => x.To, new { @class = "form-control", style = "height:20px", id = "windowTo" })
                @Html.ValidationMessageFor(x => x.To)
            </div>
            <div class="form-group">
                <label>Subject</label>
                @Html.TextBoxFor(x => x.Subject, new { @class = "form-control", style = "height:20px", id = "windowSubject" })
                @Html.ValidationMessageFor(x => x.Subject)
            </div>
            <div class="form-group">
                <label>Message</label>
                @*@Html.TextBoxFor(x => x.Body, new { @class = "form-control", style = "height:20px", id = "windowMessage" })*@
                @Html.TextAreaFor(x => x.Body, new { @class = "form-control", @style = "height:80px;", id = "windowMessage" })
                @Html.ValidationMessageFor(x => x.Body)
            </div>
            <button type="submit" class="btn btn-primary">Send</button>

        }

    </div>
    
</div>
<script>

    $(document).ready(function () {
        var EmailWindow = $("#EmailWindow");
        if (!EmailWindow.data("kendoWindow")) {
            EmailWindow.kendoWindow({
                width: "600px",
                height: "400px",
                position: { top: 300, left: 120 },
                title: "Email Message",
                actions: [
                    "Maximize",
                    "Close"
                ],
                scrollable: true,
                modal: true,

                //close: onClose
            });
        }
    });

    function additionalData() {

        return {

            //id: 47
            id: $('#routeDataId').val()

        }

    }

    function OnEmailClick(e) {
        //
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        $("#windowTo").val(dataItem.Source);
        $("#windowSubject").val('');
        $("#windowMessage").val('');

        
        var kendoWindow = $("#EmailWindow").data("kendoWindow");
        kendoWindow.center();
        kendoWindow.open();
    }

    function OnSendEmailClick(e) {
        //
        e.preventDefault();
        
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        
        $.ajax({

            url: "@Url.Action("SendEmailFromMessageLog", "Admin")",

                type: "POST",
                
                data: {
                    toEmail: dataItem.Source,
                    emailMessage :$("#windowSubject").val(''),
                    emailMessage :$("#windowMessage").val('') 
                },

                success: function (data) {
                    //
                    var emailContent = $("#EmailContent");
                    employerJobContent.empty();

                    
                    var html = "<div>";
                    html += "<h4>Message has been sent</h4>";


                    //html += "<div class=viewJobDiv >";
                    //html += "<label class ='labelFormat'>Job Title</label>";
                    //html += "<label class='valueFormat'>" + (data.JobTitleName == null ? "" : data.JobTitleName) + "</label>";
                    //html += "</div>";

                    //html += "<div class=viewJobDiv >";
                    //html += "<label class ='labelFormat'>Summary</label>";
                    //html += "<p>" + (data.JobDescription == null ? "" : data.JobDescription) + "</p>";
                    //html += "</div>";

                    //html += "<div class=viewJobDiv >";
                    //html += "<label class ='labelFormat'>Primary Responsibilities</label>";
                    //html += "<p>" + (data.PrimaryResponsibilities == null ? "" : data.PrimaryResponsibilities) + "</p>";
                    //html += "</div>";

                    //html += "<div class=viewJobDiv >";
                    //html += "<label class ='labelFormat'>Secondary Responsibilities</label>";
                    //html += "<p>" + (data.SecondaryResponsibilities == null ? "" : data.PrimaryResponsibilities) + "</p>";
                    //html += "</div>";


                    //html += "<div class=viewJobDiv >";
                    //html += "<label class ='labelFormat'>Qualifications</label>";

                    //html += "<table  style='width:90%'>";
                    //html += "   <tr>";
                    //html += "       <th>Type</th>";
                    //html += "       <th>Description</th>";
                    //html += "       <th>Weight</th>";
                    //html += "       <th>Required</th>";
                    //html += "   </tr>";

                    //$.each(data.JobQualifications, function (k, v) {
                    //    var qualificationType = "";
                    //    var qualificationDescription = "";

                    //    html += "<tr>";
                    //    html += "<td>"+v.QualificationType+"</td>";
                    //    html += "<td>" + v.QualificationDescription + "</td>";
                    //    html += "<td>" + v.Weight + "%</td>";
                    //    html += "<td>" + (v.IsRequired == "true" ? "yes" : "no") + "</td>";
                    //    html += "</tr>";

                    //});
                    //html += "</table>";
                    //html += "</div>";


                    html += "</div>";



                    emailContent.append(html);

                    var kendoWindow = $("#EmailWindow").data("kendoWindow");
                    kendoWindow.center();
                    kendoWindow.open();

                },

                error: function (jqHXHR, status, err) {
                    //
                    alert(status);
                }

            });

    }

    </script>